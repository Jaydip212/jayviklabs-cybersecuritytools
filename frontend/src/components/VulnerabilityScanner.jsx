import { useState } from 'react';
import axios from 'axios';
import { apiBaseURL } from '../utils/apiConfig';

export default function VulnerabilityScanner() {
  const [softwareName, setSoftwareName] = useState('');
  const [version, setVersion] = useState('');
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const handleScan = async () => {
    if (!softwareName.trim()) {
      setMessage('‚ö†Ô∏è Please enter software name (e.g., "apache httpd", "wordpress", "mysql")');
      return;
    }

    setLoading(true);
    setMessage('üîÑ Scanning for vulnerabilities...');

    try {
      const response = await axios.post(`${apiBaseURL}/vulnerabilities/scan`, {
        software: softwareName,
        version: version || null,
      });

      setResults(response.data);

      if (response.data.found) {
        setMessage(`‚úÖ Found ${response.data.total_cves} CVE(s) for ${response.data.software}`);
      } else {
        setMessage(`‚ö†Ô∏è ${response.data.message}`);
      }
    } catch (error) {
      setMessage(`‚ùå Error: ${error.message}`);
    }

    setLoading(false);
  };

  const getSeverityColor = (severity) => {
    switch (severity.toLowerCase()) {
      case 'critical':
        return '#ff3333';
      case 'high':
        return '#ff6633';
      case 'medium':
        return '#ffaa33';
      case 'low':
        return '#33aa33';
      default:
        return '#39ff14';
    }
  };

  const getRiskBadgeColor = (riskLevel) => {
    switch (riskLevel) {
      case 'CRITICAL':
        return 'critical-badge';
      case 'HIGH':
        return 'high-badge';
      case 'MEDIUM':
        return 'medium-badge';
      default:
        return 'low-badge';
    }
  };

  const suggestedSoftware = [
    'apache httpd',
    'openssl',
    'mysql',
    'wordpress',
    'django',
    'nginx',
    'nodejs',
    'java'
  ];

  return (
    <div className="tool-container vuln-container">
      <h2 className="tool-title">üõ°Ô∏è Vulnerability Scanner</h2>
      <p className="tool-description">
        Look up known CVEs (Common Vulnerabilities and Exposures) for software.
        Identify security risks and get remediation recommendations. This tool
        uses a simulated CVE database for educational purposes.
      </p>

      {/* Software Input */}
      <div className="vuln-section">
        <h3>üîç Software Name</h3>
        <input
          type="text"
          value={softwareName}
          onChange={(e) => setSoftwareName(e.target.value)}
          placeholder="E.g., apache httpd, wordpress, mysql, openssl..."
          className="text-input"
          onKeyPress={(e) => e.key === 'Enter' && handleScan()}
        />
      </div>

      {/* Version Input (Optional) */}
      <div className="vuln-section">
        <h3>üìå Version (Optional)</h3>
        <input
          type="text"
          value={version}
          onChange={(e) => setVersion(e.target.value)}
          placeholder="E.g., 2.4.49, 5.7.10, 1.0.2..."
          className="text-input"
        />
      </div>

      {/* Suggested Software */}
      <div className="vuln-section suggested-section">
        <h3>üí° Try These:</h3>
        <div className="suggested-buttons">
          {suggestedSoftware.map((sw) => (
            <button
              key={sw}
              className="btn-suggestion"
              onClick={() => setSoftwareName(sw)}
            >
              {sw}
            </button>
          ))}
        </div>
      </div>

      {/* Scan Button */}
      <button
        onClick={handleScan}
        disabled={loading || !softwareName.trim()}
        className="btn-primary"
      >
        {loading ? '‚è≥ Scanning...' : 'üîç Scan for CVEs'}
      </button>

      {/* Message */}
      {message && <div className="message-box">{message}</div>}

      {/* Results */}
      {results && results.found && (
        <div className="vuln-results">
          {/* Risk Badge */}
          <div className={`risk-level-badge ${getRiskBadgeColor(results.risk_level)}`}>
            {results.risk_level}
          </div>

          {/* Summary */}
          <div className="vuln-summary">
            <h3>üìä Summary</h3>
            <div className="summary-grid">
              <div className="summary-item">
                <h4>Software</h4>
                <p>{results.software}</p>
              </div>
              <div className="summary-item">
                <h4>Version</h4>
                <p>{results.version}</p>
              </div>
              <div className="summary-item">
                <h4>Total CVEs</h4>
                <p className="cve-count">{results.total_cves}</p>
              </div>
              <div className="summary-item">
                <h4>Risk Level</h4>
                <p>{results.risk_level}</p>
              </div>
            </div>
          </div>

          {/* CVE List */}
          <div className="cve-list-section">
            <h3>üî¥ Known Vulnerabilities ({results.cves.length})</h3>
            {results.cves.map((cve, index) => (
              <div key={index} className="cve-card">
                <div className="cve-header">
                  <div className="cve-id-severity">
                    <h4 className="cve-id">{cve.id}</h4>
                    <span 
                      className="severity-badge" 
                      style={{ backgroundColor: getSeverityColor(cve.severity) }}
                    >
                      {cve.severity.toUpperCase()}
                    </span>
                    <span className="cvss-score">CVSS {cve.cvss}</span>
                  </div>
                </div>

                <p className="cve-description">
                  <strong>Description:</strong> {cve.description}
                </p>

                <div className="cve-remediation">
                  <strong>üîß Remediation:</strong>
                  <p>{cve.remediation}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* No Results */}
      {results && !results.found && (
        <div className="no-results-box">
          <p>{results.message}</p>
          {results.suggestion && (
            <div className="suggestion-box">
              <strong>Suggested searches:</strong> {results.suggestion}
            </div>
          )}
          {results.available_versions && (
            <div className="versions-box">
              <strong>Available versions:</strong> {results.available_versions.join(', ')}
            </div>
          )}
        </div>
      )}

      {/* Educational Info */}
      <div className="info-section vuln-info">
        <h4>üìö Understanding CVEs</h4>
        <ul>
          <li><strong>CVE:</strong> Unique identifier for publicly disclosed security vulnerabilities</li>
          <li><strong>CVSS:</strong> Severity score (0-10) where 10 is most critical</li>
          <li><strong>Disclosure:</strong> Published after vendors have time to fix</li>
          <li><strong>Zero-Day:</strong> Vulnerabilities unknown to vendors (most dangerous)</li>
          <li><strong>Patch Management:</strong> Regular updates are crucial to stay secure</li>
          <li><strong>Responsible Disclosure:</strong> Report vulnerabilities to vendors before public release</li>
          <li><strong>Real Resources:</strong> Check NVD.NIST.gov and CVE.mitre.org for actual CVE data</li>
        </ul>
      </div>

      {/* Disclaimer */}
      <div className="disclaimer vuln-disclaimer">
        ‚ö†Ô∏è <strong>Simulated Database</strong><br/>
        This tool uses fictional CVE data for educational purposes. For real vulnerability information,
        consult official sources like <strong>NVD (National Vulnerability Database)</strong> and
        security advisories from software vendors.
      </div>
    </div>
  );
}
